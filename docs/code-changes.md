# Code Changes Log

## 2025-07-30 - Session Fallback for Legacy Members üë•

### Summary
Owners could not see activity generated by older team members whose `users/{uid}` documents were missing or had incorrect `accountId` fields. Added a fallback lookup inside `getUserSession()` to resolve the correct `accountId` from `accounts/*/members/*` when the primary data is absent. This ensures audit entries and data queries are scoped to the correct owner account.

### Changes Made
- Updated `core/session.ts`
  - Extended Firestore import with `collectionGroup`, `query`, `where`, `limit`, `getDocs`
  - Added fallback query inside the "else" branch to detect active member records and derive `accountId`, `perms`, and `isOwner`.
  - Added detailed warning logs if fallback lookup fails.

### Impact
- Owners can now view member activity generated by legacy accounts.
- No behavioural change for properly configured users; fallback only runs when needed.
- Minimal performance overhead thanks to `limit(1)`.

### Additional Activity-Log Coverage (Runsheet)
- Added audit types: `job_price_changed`, `job_deleted`, `job_completed`, `runsheet_note_added`.
- Updated `services/auditService.ts` description helper.
- Instrumented `app/runsheet/[week].tsx` to log:
  - Note additions
  - Price edits
  - Job deletions
  - Job completions

---

## 2025-02-02 - Enhanced Activity Log Reliability with Fallback Mechanisms üîß

### Summary
Added defensive programming and fallback mechanisms to the activity log system to address potential issues where owners might not see member activity due to session setup problems. This patch improves reliability while maintaining performance and minimizing regression risk.

### Issues Addressed
- **Missing User Documents**: Members without proper `users/{uid}` documents causing session failures
- **Incorrect Account ID**: Members with wrong `accountId` in their user documents
- **Session Resolution Failures**: Cases where `getDataOwnerId()` returns null for team members
- **Poor Error Visibility**: Limited debugging information when audit logging fails

### Changes Made

**1. Added Fallback Owner ID Resolution**:
- New `fallbackGetDataOwnerId()` function that attempts to find member records when primary session resolution fails
- Uses `collectionGroup` query to find active member records across all accounts
- Falls back to treating user as owner of their own account if no member record found

**2. Enhanced Error Handling & Logging**:
- Added detailed console logging with emojis for better visibility
- Logs session state information when failures occur
- Includes action context in error messages for debugging
- Shows owner ID in successful audit log messages

**3. Defensive Programming**:
- Tries fallback mechanism only when primary `getDataOwnerId()` fails
- Maintains backward compatibility - no changes to happy path
- Graceful degradation - doesn't break main operations if audit logging fails

### Technical Implementation

**Fallback Logic Flow**:
```typescript
1. Try primary getUserSession() ‚Üí getDataOwnerId()
2. If fails: Try fallbackGetDataOwnerId(userUid)
   - Query: collectionGroup('members').where('uid', '==', userUid)
   - Extract accountId from member document path
   - Return accountId as owner ID
3. If still fails: Assume user is owner (userUid)
```

**Enhanced Logging Examples**:
```
‚úÖ Audit logged: client_created - Created client for "123 Main St" (ownerId: abc123)
‚ö†Ô∏è getDataOwnerId() returned null, attempting fallback resolution...
üîÑ Attempting fallback owner ID resolution for user: def456
‚úÖ Fallback successful: Found member record, using accountId: abc123
‚ùå Cannot log audit action: no owner ID found after all attempts
```

### Performance Characteristics
- **Happy Path**: Zero performance impact (no extra queries)
- **Fallback Path**: One additional `collectionGroup` query only when primary method fails
- **Query Efficiency**: Uses `limit(1)` and targeted `where` clauses
- **Caching**: Leverages Firestore's built-in query caching

### Risk Assessment
- ‚úÖ **Low Regression Risk**: Only adds safety nets, doesn't modify core logic
- ‚úÖ **Backward Compatible**: All existing functionality preserved
- ‚úÖ **Graceful Degradation**: Failures don't break main app operations
- ‚úÖ **Enhanced Debugging**: Better visibility into audit logging issues

### Expected Outcomes
- **Improved Reliability**: Activity logs work even with incomplete session setup
- **Better Debugging**: Clear console messages help identify root causes
- **Reduced Support Issues**: Fewer "missing audit logs" problems
- **Team Visibility**: Owners more likely to see all member activities

### Files Modified
- `services/auditService.ts` - Enhanced logAction() with fallback mechanisms and better logging
- `docs/code-changes.md` - Documentation update

**Priority**: MEDIUM - Improves reliability and debugging capabilities while maintaining performance

--- 

### 2025-01-18: Downgraded React Native
Additionally downgraded react-native from 0.79.5 to 0.75.4 to match Expo SDK 53's compatible version, resolving peer dependency conflicts with React 18.2.0 and fixing EAS build bundling errors. 

### 2025-01-18: Used legacy-peer-deps
Ran `npm install --legacy-peer-deps` to resolve remaining dependency conflicts after version downgrades, allowing installation despite peer version mismatches for optional dependencies like react-native-windows. 

### 2025-01-18: Fixed Dependencies with Expo
Ran `npx expo install --fix` to automatically align all dependency versions with Expo SDK 53 requirements, resolving version conflicts, and fixing the Metro bundler module error. 

### 2025-01-18: Aligned Dependencies with Expo SDK 53
Ran `npx expo install --fix` to automatically update React to 19.0.0, react-dom to 19.0.0, and react-native to 0.79.5, matching Expo SDK 53 expectations and resolving bundling conflicts without impacting Vercel web builds. 

### 2025-01-18: Explicit Expo Install and Re-Fix
Explicitly installed expo@53.0.20 and re-ran `npx expo install --fix` to ensure dependency alignment for SDK 53, addressing build issues without affecting web/Vercel compatibility. 

### 2025-01-18: Updated Metro Config for Bundling Fixes
Updated metro.config.js to include explicit resolver options (extraNodeModules for crypto/stream, SVG handling) to resolve path-related bundling errors in EAS Android builds. Confirmed React 19.0.0 and React Native 0.79.5 versions match Expo SDK 53 without impacting Vercel web deployments. 